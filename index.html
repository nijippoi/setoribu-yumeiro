<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="index.webmanifest" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <title>萌ディスセトリ</title>

    <style>
        #songs .song[data-song]::before {
            content: attr(data-song);
        }

        #setlist .song[data-song]::after {
            content: attr(data-song);
        }

        .song[data-moving] {
            background-color: #afafaf !important;
        }

        .song-remove::before {
            content: "✖";
        }
    </style>
</head>

<body>
    <section class="section p-2">
        <div class="container">
            <div class="field mb-1" id="live-title">
                <div class="control">
                    <input class="input is-small" type="text" placeholder="ライブ名" />
                </div>
            </div>
            <div class="columns is-mobile is-variable is-1 mb-0">
                <div class="column is-half">
                    <div class="field" id="live-place">
                        <div class="control">
                            <input class="input is-small" type="text" placeholder="会場" />
                        </div>
                    </div>
                </div>
                <div class="column is-half">
                    <div class="field" id="live-date">
                        <div class="control">
                            <input class="input is-small" type="date" placeholder="日付" data-start-date="10/24/2019">
                        </div>
                    </div>
                </div>
            </div>
            <div class="columns is-mobile is-variable is-1 mb-0">
                <div class="column is-half">
                    <article id="setlist" class="panel is-info mb-1">
                        <p class="panel-heading is-size-7">セットリスト</p>
                    </article>
                    <div id="custom-song" class="field has-addons mb-1">
                        <div class="control is-expanded">
                            <input class="input is-small" type="text" placeholder="自由書き" />
                        </div>
                        <div class="control">
                            <a id="custom-song-add" class="button is-small is-info">＋</a>
                        </div>
                    </div>
                </div>
                <div class="column is-half">
                    <article id="songs" class="panel is-info">
                        <p class="panel-heading is-size-7">曲</p>
                    </article>
                </div>
            </div>
            <div class="field mb-1" id="message">
                <div class="control">
                    <textarea class="textarea is-small" rows="10" placeholder="メッセージ"></textarea>
                </div>
            </div>
            <div class="buttons mb-1">
                <button id="copy-button" class="button is-small is-primary">コピー</button>
                <a id="tweet-button" class="button is-small is-info" href="#">ツイート</a>
                <button id="clear-button" class="button is-small is-danger is-right">リセット</button>
            </div>
        </div>
    </section>

    <script>
        const hashTags = ['萌ディス', '萌燃ディストラクション', '萌ディスセトリ'];
        const relatedAccounts = ['moe_destruction', 'nana_kumori', 'amina_minase', 'tenn_komiya', 'narua_ngo', 'renpha_hisaki'];
        const songs = ['SE', 'MC', '_Rebirth.', 'わたしはもうきみのじゃない。', '囚われカタストロフィー', 'C.A.R', 'MU-ZE', 'NEVER STAY', '\'aimer', '彼氏キミ攻略法', 'すたーとあっぷ☆しぐなる', '戦争的可愛症候群', '世代交代、反逆の狼煙', '☆酒クズファーーック☆', '絶対絶命、開示請求', 'Rebellion', 'HALU'];
        function songDragStart(evt) {
            // ✖などの内部要素の場合は無視したいので
            if (evt.srcElement.classList.contains('song')) {
                evt.preventDefault();
                const songElem = evt.srcElement;
                songElem.setAttribute('data-moving', 'true');
                songElem.addEventListener('touchmove', songDrag);
                songElem.addEventListener('touchend', songDragStop);
                document.body.addEventListener('mousemove', songDrag);
                document.body.addEventListener('mouseup', songDragStop);
                document.body.addEventListener('mouseleave', songDragStop);
                document.body.addEventListener('touchleave', songDragStop);
            }
        }
        function songDrag(evt) {
            const songElem = document.querySelector('#setlist .song[data-moving]');
            if (songElem) {
                const songElemTop = songElem.getBoundingClientRect().top;
                const songElemBottom = songElem.getBoundingClientRect().bottom;
                const y = evt.type === 'mousemove' ? evt.pageY : evt.changedTouches[0].pageY;
                if (y < songElemTop && songElem.previousElementSibling && songElem.previousElementSibling.classList.contains('song')) {
                    // 上に移動
                    songElem.parentNode.insertBefore(songElem, songElem.previousElementSibling);
                    generateMessage();
                } else if (y > songElemBottom && songElem.nextElementSibling && songElem.nextElementSibling.classList.contains('song')) {
                    // 下に移動
                    songElem.parentNode.insertBefore(songElem.nextElementSibling, songElem);
                    generateMessage();
                }
            } else {
                evt.srcElement.removeEventListener('touchmove', songDrag);
                document.body.removeEventListener('mousemove', songDrag);
                document.body.removeEventListener('mouseup', songDragStop);
                document.body.removeEventListener('mouseleave', songDragStop);
                document.body.removeEventListener('touchleave', songDragStop);
                return;
            }
        }
        function songDragStop(evt) {
            for (const movingElem of document.querySelectorAll('#setlist .song[data-moving]')) {
                movingElem.removeAttribute('data-moving');
            }
            evt.srcElement.removeEventListener('touchmove', songDrag);
            evt.srcElement.removeEventListener('touchend', songDragStop);
            document.body.removeEventListener('mousemove', songDrag);
            document.body.removeEventListener('mouseup', songDragStop);
            document.body.removeEventListener('mouseleave', songDragStop);
            document.body.removeEventListener('touchleave', songDragStop);
        }
        function addSong(song) {
            const removeElem = document.createElement('span');
            removeElem.classList.add('panel-icon', 'song-remove');
            removeElem.addEventListener('click', (evt) => {
                console.log('セトリから削除', evt.target.parentNode.dataset.song);
                evt.target.parentNode.parentNode.removeChild(evt.target.parentNode);
                generateMessage();
            }, true);
            const setlistSongElem = document.createElement('a');
            setlistSongElem.classList.add('panel-block', 'song', 'is-size-7');
            setlistSongElem.appendChild(removeElem);
            setlistSongElem.dataset.song = song;
            setlistSongElem.addEventListener('mousedown', songDragStart);
            setlistSongElem.addEventListener('touchstart', songDragStart);
            // セットリストを作成
            const setlistElem = document.getElementById('setlist');
            // <a class="panel-block setlist is-size-7" data-song="曲名">
            //     <span class="panel-icon song-move-up"></span>
            //     <span class="panel-icon song-move-down"></span>
            //     <span class="panel-icon song-remove"></span>
            // </a>
            setlistElem.appendChild(setlistSongElem);
            generateMessage();
        }
        function renderSongs() {
            const songsElem = document.getElementById('songs');
            for (const song of songs) {
                // <a class="panel-block song is-size-7" data-song="曲名"></a>
                const songElem = document.createElement('a');
                songElem.classList.add('panel-block', 'song', 'is-size-7');
                songElem.dataset.song = song;
                songElem.addEventListener('click', (evt) => {
                    addSong(song);
                });
                songsElem.appendChild(songElem);
            }
        }
        function generateMessage() {
            // 入力値を保存
            document.getElementById('live-title').getElementsByTagName('input').item(0).value ? localStorage.setItem('live-title', document.getElementById('live-title').getElementsByTagName('input').item(0).value) : localStorage.removeItem('live-title');
            document.getElementById('live-place').getElementsByTagName('input').item(0).value ? localStorage.setItem('live-place', document.getElementById('live-place').getElementsByTagName('input').item(0).value) : localStorage.removeItem('live-place');
            document.getElementById('live-date').getElementsByTagName('input').item(0).value ? localStorage.setItem('live-date', document.getElementById('live-date').getElementsByTagName('input').item(0).value) : localStorage.removeItem('live-date');
            // メッセージを生成
            const title = document.getElementById('live-title').getElementsByTagName('input').item(0).value;
            const place = document.getElementById('live-place').getElementsByTagName('input').item(0).value;
            const dateStr = document.getElementById('live-date').getElementsByTagName('input').item(0).value ? new Intl.DateTimeFormat('ja-JP').format(document.getElementById('live-date').getElementsByTagName('input').item(0).valueAsDate) : '';
            const setlist = [];
            for (const elem of document.querySelectorAll('#setlist .song')) {
                if (elem.dataset.song) {
                    setlist.push(elem.dataset.song);
                }
            }
            setlist && setlist.length > 0 ? localStorage.setItem('setlist', JSON.stringify(setlist)) : localStorage.removeItem('setlist');
            const setlistStr = Array.isArray(setlist) ? setlist.join('\n') : '';
            const hashTagsStr = hashTags.map(ht => '#' + ht).join('\n');
            const messageTextarea = `${dateStr ? dateStr + '\n' : ''}${title ? title + '\n' : ''}${place ? '@ ' + place + '\n' : ''}${setlistStr ? '\n' + setlistStr + '\n' : ''}${hashTagsStr ? '\n' + hashTagsStr : ''}`;
            document.getElementById('message').getElementsByTagName('textarea').item(0).value = messageTextarea;
            const tweetButton = document.getElementById('tweet-button');
            const twitterIntentUrl = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(messageTextarea) + '&related=' + encodeURIComponent(relatedAccounts.join(','));
            tweetButton.href = twitterIntentUrl;
        }
        function load() {
            // 入力値を復活
            if (localStorage.getItem('live-title')) {
                document.getElementById('live-title').getElementsByTagName('input').item(0).value = localStorage.getItem('live-title');
            }
            if (localStorage.getItem('live-place')) {
                document.getElementById('live-place').getElementsByTagName('input').item(0).value = localStorage.getItem('live-place');
            }
            if (localStorage.getItem('live-date')) {
                document.getElementById('live-date').getElementsByTagName('input').item(0).value = localStorage.getItem('live-date');
            }
            if (localStorage.getItem('setlist')) {
                const setlist = JSON.parse(localStorage.getItem('setlist'));
                for (const song of setlist) {
                    addSong(song);
                }
            }
            // 初期化
            if (!document.getElementById('live-date').getElementsByTagName('input').item(0).value) {
                document.getElementById('live-date').getElementsByTagName('input').item(0).valueAsDate = new Date();
            }
            renderSongs();
            if (!document.querySelectorAll('#setlist .song') || document.querySelectorAll('#setlist .song').length < 1) {
                addSong('SE');
            }
            generateMessage();
            // リスナーを追加
            document.getElementById('copy-button').addEventListener('click', (evt) => {
                document.querySelector('#message .textarea').select();
                document.execCommand('copy');
                window.alert('クリップボードにコピーしました');
            });
            document.getElementById('clear-button').addEventListener('click', (evt) => {
                document.getElementById('live-title').getElementsByTagName('input').item(0).value = null;
                document.getElementById('live-place').getElementsByTagName('input').item(0).value = null;
                document.getElementById('live-date').getElementsByTagName('input').item(0).valueAsDate = new Date();
                const setlistElem = document.getElementById('setlist');
                for (const songElem of setlistElem.querySelectorAll('.song')) {
                    setlistElem.removeChild(songElem);
                }
                addSong('SE');
                generateMessage();
            });
            document.getElementById('custom-song-add').addEventListener('click', (evt) => {
                const song = document.querySelector('#custom-song input').value;
                if (song) {
                    addSong(song);
                }
            });
            for (const elem of document.querySelectorAll('input')) {
                elem.addEventListener('change', (evt) => {
                    generateMessage();
                });
                elem.addEventListener('input', (evt) => {
                    generateMessage();
                });
            }
        }
        addEventListener('DOMContentLoaded', load);
    </script>
</body>

</html>